<!doctype html>
<html lang="en">
<!-- Fighting mongoose  file load  -->

	<head>
		<meta charset="UTF-8">
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
			  integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
		<link rel="stylesheet" type="text/css" href="/Templates/myStyles.css">
		<link rel="shortcut icon" type="image/ico" href="/Assets/Bits_and_Bytes_Logo.ico"/>
    <title>Form Upload</title>
		<script src='https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js' type='text/javascript'></script>
		<script type='text/javascript'>
			$.get('../Templates/Header.html',function(response){
				$('#header').html(response);
			});
			$.get('../Templates/Footer.html',function(response){
				$('#footer').html(response);
			});
		</script>
	</head>

	<script>
    async function createGroupButtons() {
      const resp = await fetch(`${ROOT_URI}/api/email/groups`, {
        credentials: 'include',
        headers: {
        'Content-Type': 'application/json'
        },
      })
      .then(resp => { return resp.json() })
      .then(data => { return data })
      .catch(err => { 
        displayAlert("Failed to collect emails. Please sign in again if needed", 'alert-danger')
        return ''
      })

      // build buttons for each group
      resp.forEach(group => {
        const group_name = group['type']

        const obj = document.createElement('button')
        obj.type = 'button'
        obj.name = 'group_name'
        obj.classList = 'btn btn-small btn-info'
        obj.setAttribute('data-toggle', 'button')
        obj.onclick = (event) => setEmails(event, `${group_name}`)
        obj.textContent = 'All ' + group_name + 's'

        document.querySelector('#btns-container').appendChild(obj)
      })

    }

    async function setEmails(evt, group) {
      const action = evt.target.classList.contains('active') ? 'remove' : 'add'
      const group_emails = await getEmails(group)
      let current_emails = $('#email_to').val().toLowerCase().split(';')


      // console.log(action)
      // console.log(group)
      console.log(current_emails)


      if (action === 'add') {
        current_emails = new Set(current_emails.concat(group_emails))
      } else if (action === 'remove') {
        current_emails = current_emails.filter(email => { return !group_emails.includes(email) })
      }

      // filter out blank emails and join with ';'
      current_emails = Array.from(current_emails).filter(email => { return email !== '' }).join(';')
      $('#email_to').val(current_emails)
    }

    async function getEmails(group) {
      let uri = `${ROOT_URI}/api/email/${group}`
      let emails = ''

      const resp = await fetch(uri, {
        credentials: 'include',
        headers: {
        'Content-Type': 'application/json'
        },
      })
      .then(resp => { return resp.json() })
      .then(data => { return data })
      .catch(err => { 
        displayAlert("Failed to collect emails. Please sign in again if needed", 'alert-danger')
        return ''
      })

      return resp.map(ele => { return ele['email'].toLowerCase() })
    }




    function sendEmail() {
      displayAlert('Email is being sent', 'alert-info')
      const to = $('#email_to').val()
      const subject = $('#email_subject').val()
      const body = $('#email_body').val()


      fetch(`${ROOT_URI}/api/email/sendEmail`, {
        credentials: 'include',
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          to: to,
          subject: subject,
          body: body
        })
      })
        .then(async resp => {
          if (resp.status == 200) {
            const data = await resp.json()
            displayAlert('Email is has been sent to: ' + data['sentTo'].join('; '), 'alert-success')
          }
          else
            displayAlert('Email has not been sent, an error has occured', 'alert-danger')
        })
        .catch(err => {
          displayAlert("No connection, please sign in again if needed", 'alert-danger');
        })
    }

  </script>
  <script type="text/javascript" src="/js/root_uri.js"></script>
  <script type="text/javascript" src="/js/display_alert.js"></script>




	<body onload='createGroupButtons()'>
    <header id="header"></header>

    <!-- Alert -->
    <div class="alert alert-dismissible fade show fixed-top" role="alert">
      <span id='alert_text'></span>
    </div>


    <form class='text-center' onsubmit='event.preventDefault(); sendEmail()'>
      <h1>Send an email</h1>
      <hr class="half_horizontal_rule">

      <div id='btns-container'></div>
      <br><br>

      <div class="input-group mb-3 col-12">

        <div class="input-group-prepend">
          <span class="input-group-text" id="inputGroup-sizing-default" for="email_to">
            To
          </span>
        </div>

        <textarea id="email_to" name="email_to" type="text" class="form-control" aria-label="Default" aria-describedby="inputGroup-sizing-default" rows="2"></textarea>
      </div>


      <div class="input-group mb-3 col-12">
        <div class="input-group-prepend">
          <span class="input-group-text" id="inputGroup-sizing-default" for="email_subject">
            Subject
          </span>
        </div>
        <input id="email_subject" name="email_subject" type="text" class="form-control" aria-label="Default" aria-describedby="inputGroup-sizing-default">
      </div>

      <div class="input-group mb-3 col-12">
        <div class="input-group-prepend">
          <span class="input-group-text" id="inputGroup-sizing-default" for="email_body">
            Body
          </span>
        </div>
        <textarea id="email_body" name="email_body" type="text" class="form-control rounded-0" aria-label="Default" aria-describedby="inputGroup-sizing-default" rows="6"></textarea>
      </div>

      <!--
        <button class='btn btn-info btn-md' type="button" name="file" size="75" id="impfile" onclick="showImage()">Preview</button>
      -->

    
    <button class='btn btn-primary btn-lg'>Send Email</button> 

    </form>
    <!-- END TAB REQ FILES -->



    <footer id="footer"></footer>



    <!-- jQuery things -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
            integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
            crossorigin="anonymous">
    </script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
            integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
            crossorigin="anonymous">
    </script>
	</body>
</html>
